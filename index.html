<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Flow — 6 Pillars</title>

  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#0b1220;
      --line:rgba(255,255,255,.08);
      --muted:#93a4c7;
      --text:#e8eefc;
      --cell:#0f1729;
      --pinkSoft: rgba(255,95,162,.22);
      --pink: rgba(255,95,162,.75);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(255,95,162,.12), transparent 60%),
        radial-gradient(900px 500px at 100% 30%, rgba(43,108,255,.14), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:24px}
    .topbar{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;}
    h1{margin:0;font-size:22px}
    .date{color:var(--muted);font-size:14px;margin-top:4px}

    .btnrow{
      display:flex;gap:10px;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;
    }
    button{
      background:transparent;border:1px solid var(--line);color:var(--text);
      padding:12px 14px;border-radius:14px;
      font-size:15px;font-weight:650;white-space:nowrap;cursor:pointer;
    }
    button:hover{border-color:rgba(255,255,255,.2)}
    button.primary{border-color:rgba(255,255,255,.20)}
    button.hidden{display:none}

    .layout{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .sectionTitle{font-weight:800;margin:0 0 8px}
    .subtle{color:var(--muted);font-size:13px;line-height:1.35}
    .small{font-size:12px;color:var(--muted)}

    /* --------- Grids --------- */
    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: max-content repeat(6, minmax(0, 1fr));
      gap:10px;
      align-items:center;
    }
    .hdr{
      color:var(--muted);
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      text-align:center;
      white-space:nowrap;
      padding:6px 4px;
    }
    .hdr.left{padding:0}
    .hdrBand{
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(255,255,255,.02);
    }
    .hdrBand span{
      display:block;
      padding:6px 0;
      font-weight:800;
      font-size:11px;
      letter-spacing:.18em;
    }
    .pill{
      display:flex;align-items:center;
      padding:10px 14px;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(255,255,255,.02);
      font-weight:750;
      white-space:nowrap;
    }
    .cell{
      border:1px solid var(--line);
      border-radius:14px;
      background: var(--cell);
      min-height:48px;
      padding:8px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      user-select:none;
    }
    .cell.on{
      background: var(--pinkSoft);
      border-color: rgba(255,95,162,.55);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,95,162,.25);
    }

    /* Heatmap cells */
    .hmcell{
      border:1px solid var(--line);
      border-radius:14px;
      min-height:48px;
      padding:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.02);
      color:var(--muted);
      white-space:nowrap;
    }
    .hmcell strong{color:var(--text)}

    /* --------- Journal blocks --------- */
    .journalBox{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.02);
      padding:12px;
    }
    .journalTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .journalTitle{font-weight:800;margin:0}
    .journalActions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .miniBtn{padding:8px 10px;font-size:13px;border-radius:12px}

    textarea{
      width:100%;
      margin-top:10px;
      min-height:92px;
      background: rgba(15,23,41,.75);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      color: var(--text);
      padding:12px;
      resize: vertical;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:14px;
      line-height:1.35;
    }
    .displayBlock{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      background: rgba(15,23,41,.45);
      border:1px solid rgba(255,255,255,.06);
      color: var(--text);
      white-space:pre-wrap;
    }

    .dots{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .dotLabel{color:var(--muted); font-size:12px}
    .dotRow{display:flex; gap:8px; align-items:center}
    .dotBtn{
      width:18px;height:18px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      cursor:pointer;
    }
    .dotBtn.on{
      background: var(--pink);
      border-color: rgba(255,95,162,.9);
      box-shadow: 0 0 0 3px rgba(255,95,162,.14) inset;
    }

    /* --------- Pillar descriptions --------- */
    .descList{margin:10px 0 0 0; padding-left:18px; color:var(--text);}
    .descList li{margin:8px 0}
    .descList span{color:var(--muted)}

    /* --------- History --------- */
    .calTop{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .calBtns{display:flex;gap:8px;flex-wrap:wrap}
    .calendar{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }
    .dow{
      color:var(--muted);
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:6px 6px;
      border-bottom:1px solid var(--line);
      text-align:center;
      white-space:nowrap;
    }
    .day{
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(255,255,255,.02);
      min-height:44px;
      padding:8px 8px;
      cursor:pointer;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      color:var(--muted);
    }
    .day:hover{border-color:rgba(255,255,255,.2)}
    .day.muted{opacity:.35; cursor:default}
    .day.selected{
      border-color: rgba(255,95,162,.6);
      box-shadow: inset 0 0 0 1px rgba(255,95,162,.25);
      color:var(--text);
    }
    .day.hasData{background: rgba(255,95,162,.10)}
    .badge{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
    }
    .badge.on{border-color:rgba(255,95,162,.5); color:var(--text); background: rgba(255,95,162,.14)}
    .historyList{margin-top:10px; max-height:260px; overflow:auto}
    .historyItem{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(255,255,255,.02);
      margin-top:8px;
      cursor:pointer;
      color:var(--muted);
      gap:10px;
    }
    .historyItem:hover{border-color:rgba(255,255,255,.2)}
    .historyItem strong{color:var(--text)}
    .calTitle{font-weight:800}

    /* Views */
    .view{display:none}
    .view.active{display:block}

    /* Mobile */
    @media(max-width:980px){
      .layout{grid-template-columns:1fr}
      .cell,.hmcell{min-height:34px;padding:6px}
      .pill{padding:8px 12px}
      .hdrBand{margin-top:-6px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Daily Flow — 6 Pillars</h1>
        <div class="date" id="activeLabel"></div>
      </div>

      <div class="btnrow">
        <button id="btnTodayView" class="primary">Today</button>
        <button id="btnWeeklyView">Weekly</button>
        <button id="btnMonthlyView">Monthly</button>
        <button id="btnClear">Clear Day</button>
        <button id="btnInstall" class="hidden">Install App</button>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT -->
      <div class="card">
        <div id="viewToday" class="view active">
          <p class="sectionTitle">Daily Map</p>
          <p class="subtle">Tap where you feel strongest. Multiple selections are allowed.</p>

          <!-- Intention -->
          <div class="journalBox">
            <div class="journalTop">
              <div>
                <div class="journalTitle">Daily Intention</div>
                <div class="small">A short sentence for how you want to show up today.</div>
              </div>
              <div class="journalActions">
                <button class="miniBtn" id="btnEditIntention">Edit</button>
                <button class="miniBtn hidden" id="btnSaveIntention">Save</button>
                <button class="miniBtn hidden" id="btnCancelIntention">Cancel</button>
              </div>
            </div>

            <div id="intentionDisplay" class="displayBlock">No intention yet — tap Edit.</div>
            <textarea id="intentionText" class="hidden" placeholder="Example: Move slowly, speak kindly, and protect my energy."></textarea>

            <div class="dots">
              <div class="dotLabel">End-of-day check-in:</div>
              <div class="dotRow" id="dotRow"></div>
              <div class="small">Tap 1–3 dots (3 = awesome day).</div>
            </div>
          </div>

          <!-- Gratitude -->
          <div class="journalBox">
            <div class="journalTop">
              <div>
                <div class="journalTitle">Gratitude</div>
                <div class="small">A few quick lines — what are you thankful for today?</div>
              </div>
              <div class="journalActions">
                <button class="miniBtn" id="btnEditGratitude">Edit</button>
                <button class="miniBtn hidden" id="btnSaveGratitude">Save</button>
                <button class="miniBtn hidden" id="btnCancelGratitude">Cancel</button>
              </div>
            </div>

            <div id="gratitudeDisplay" class="displayBlock">No gratitude note yet — tap Edit.</div>
            <textarea id="gratitudeText" class="hidden" placeholder="Example: Morning coffee, a kind text, fresh air, my family."></textarea>
          </div>

          <div class="grid" id="grid"></div>
        </div>

        <div id="viewWeekly" class="view">
          <p class="sectionTitle">Weekly Heatmap</p>
          <p class="subtle">Counts show how many of the last 7 days you selected each slot.</p>
          <div class="grid" id="weeklyGrid"></div>
          <p class="small" id="weeklyLabel"></p>
        </div>

        <div id="viewMonthly" class="view">
          <p class="sectionTitle">Monthly Heatmap</p>
          <p class="subtle">Counts show how many days in the month you selected each slot.</p>
          <div class="grid" id="monthlyGrid"></div>
          <p class="small" id="monthlyLabel"></p>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="calTop">
          <div>
            <div class="calTitle" id="calMonthLabel"></div>
            <div class="subtle">Tap a day to open/edit. Days with data are highlighted.</div>
          </div>
          <div class="calBtns">
            <button id="btnPrevMonth">◀</button>
            <button id="btnNextMonth">▶</button>
            <button id="btnJumpToday">Jump to Today</button>
          </div>
        </div>

        <div class="calTop" style="margin-top:10px;">
          <div class="badge" id="dataBadge">0 days saved</div>
        </div>

        <div class="calendar" id="calendar"></div>
        <div class="historyList" id="historyList"></div>
      </div>
    </div>

    <!-- Pillar Descriptions at Bottom -->
    <div class="card" style="margin-top:14px;">
      <p class="sectionTitle">Pillar Descriptions</p>
      <ul class="descList">
        <li><strong>Energy</strong> — <span>Find patterns to help you map your day according to your natural energy levels. You are not yourself when tired and hungry.</span></li>
        <li><strong>Mind</strong> — <span>Prioritize mental health and put positive psychology into action with daily intentions, brain dumps, and gratitude affirmations.</span></li>
        <li><strong>Movement</strong> — <span>Celebrate movement, from seated stretches to gentle walks and high-impact activities.</span></li>
        <li><strong>Nourishment</strong> — <span>Let go of rigid goals to make space for favorite recipes and food that makes your body and mind feel good.</span></li>
        <li><strong>Connection</strong> — <span>Foster kind, inspiring moments with the people and things that lift you up — experiences, culture, and in-person interactions.</span></li>
        <li><strong>Rest</strong> — <span>The antidote to “to-do.” Build screen-free downtime into your day and explore stillness, micro naps, and meditations.</span></li>
      </ul>
    </div>
  </div>

<script>
  const PILLARS = ["Energy","Mind","Movement","Nourishment","Connection","Rest"];
  const SLOTS = ["E-AM","M-AM","L-AM","E-PM","M-PM","L-PM"];

  const STORE_KEY = "dailyFlow.pillars.main";
  const LEGACY_KEYS = [
    "dailyFlow.pillars.v6",
    "dailyFlow.pillars.v5",
    "daily-flow-final",
    "daily-flow-v7",
    "daily-flow-v1",
    "daily-flow-final"
  ];

  // Elements
  const elActiveLabel = document.getElementById("activeLabel");
  const elGrid = document.getElementById("grid");
  const elWeeklyGrid = document.getElementById("weeklyGrid");
  const elMonthlyGrid = document.getElementById("monthlyGrid");
  const elWeeklyLabel = document.getElementById("weeklyLabel");
  const elMonthlyLabel = document.getElementById("monthlyLabel");

  const elCalMonthLabel = document.getElementById("calMonthLabel");
  const elCalendar = document.getElementById("calendar");
  const elHistoryList = document.getElementById("historyList");
  const elDataBadge = document.getElementById("dataBadge");

  const btnTodayView = document.getElementById("btnTodayView");
  const btnWeeklyView = document.getElementById("btnWeeklyView");
  const btnMonthlyView = document.getElementById("btnMonthlyView");
  const btnClear = document.getElementById("btnClear");

  const btnPrevMonth = document.getElementById("btnPrevMonth");
  const btnNextMonth = document.getElementById("btnNextMonth");
  const btnJumpToday = document.getElementById("btnJumpToday");

  // Intention UI
  const btnEditIntention = document.getElementById("btnEditIntention");
  const btnSaveIntention = document.getElementById("btnSaveIntention");
  const btnCancelIntention = document.getElementById("btnCancelIntention");
  const intentionDisplay = document.getElementById("intentionDisplay");
  const intentionText = document.getElementById("intentionText");
  const dotRow = document.getElementById("dotRow");

  // Gratitude UI
  const btnEditGratitude = document.getElementById("btnEditGratitude");
  const btnSaveGratitude = document.getElementById("btnSaveGratitude");
  const btnCancelGratitude = document.getElementById("btnCancelGratitude");
  const gratitudeDisplay = document.getElementById("gratitudeDisplay");
  const gratitudeText = document.getElementById("gratitudeText");

  // Install
  const btnInstall = document.getElementById("btnInstall");
  let deferredInstallPrompt = null;

  let activeDateKey = isoLocalDate(new Date());
  let calCursor = new Date();

  // helpers
  function pad(n){ return String(n).padStart(2,"0"); }
  function isoLocalDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function parseDateKey(key){ const [y,m,dd]=key.split("-").map(Number); return new Date(y, m-1, dd); }
  function monthName(d){ return d.toLocaleString(undefined, {month:"long", year:"numeric"}); }

  function safeParse(json){
    try { return JSON.parse(json); } catch(e){ return null; }
  }

  function migrateIfNeeded(){
    const current = safeParse(localStorage.getItem(STORE_KEY) || "{}") || {};
    let changed = false;

    for(const k of LEGACY_KEYS){
      const legacyRaw = localStorage.getItem(k);
      if(!legacyRaw) continue;
      const legacy = safeParse(legacyRaw);
      if(!legacy || typeof legacy !== "object") continue;

      for(const dayKey of Object.keys(legacy)){
        if(!current[dayKey]) {
          current[dayKey] = legacy[dayKey];
          changed = true;
        }
      }
    }
    if(changed) localStorage.setItem(STORE_KEY, JSON.stringify(current));
  }

  function loadAll(){ return safeParse(localStorage.getItem(STORE_KEY) || "{}") || {}; }
  function saveAll(data){ localStorage.setItem(STORE_KEY, JSON.stringify(data)); }

  function ensureDay(data, dateKey){
    if(!data[dateKey]) data[dateKey] = {};
    for(const p of PILLARS){
      if(!data[dateKey][p]) data[dateKey][p] = Array(6).fill(0);
    }
    if(typeof data[dateKey].intentionText !== "string") data[dateKey].intentionText = "";
    if(typeof data[dateKey].intentionScore !== "number") data[dateKey].intentionScore = 0;
    if(typeof data[dateKey].gratitudeText !== "string") data[dateKey].gratitudeText = "";
    return data;
  }

  function dayHasAnySelection(dayObj){
    if(!dayObj) return false;
    if((dayObj.intentionText || "").trim().length > 0) return true;
    if((dayObj.gratitudeText || "").trim().length > 0) return true;
    if((dayObj.intentionScore || 0) > 0) return true;

    for(const p of PILLARS){
      const arr = dayObj[p] || [];
      if(arr.some(x => x === 1)) return true;
    }
    return false;
  }

  function countSelectionsInDay(dayObj){
    if(!dayObj) return 0;
    let c=0;
    for(const p of PILLARS){
      const arr = dayObj[p] || [];
      for(const v of arr) c += (v ? 1 : 0);
    }
    return c;
  }

  function setActiveDate(dateKey){
    activeDateKey = dateKey;
    elActiveLabel.textContent = `Selected day: ${activeDateKey}`;
    renderToday();
    renderWeekly();
    renderMonthly();
    renderCalendar();
    renderHistoryList();
  }

  function cellDiv(text, cls){
    const d = document.createElement("div");
    d.className = cls;
    d.textContent = text;
    return d;
  }
  function pillDiv(text){
    const d = document.createElement("div");
    d.className = "pill";
    d.textContent = text;
    return d;
  }

  function addHeaderRows(targetEl){
    targetEl.appendChild(cellDiv("", "hdr left"));

    const am = document.createElement("div");
    am.className = "hdr hdrBand";
    am.style.gridColumn = "2 / span 3";
    am.innerHTML = `<span>AM</span>`;
    targetEl.appendChild(am);

    const pm = document.createElement("div");
    pm.className = "hdr hdrBand";
    pm.style.gridColumn = "5 / span 3";
    pm.innerHTML = `<span>PM</span>`;
    targetEl.appendChild(pm);

    targetEl.appendChild(cellDiv("", "hdr"));
    for(const s of SLOTS) targetEl.appendChild(cellDiv(s, "hdr"));
  }

  // --- edit modes ---
  function setEditMode(type, isEditing){
    if(type === "intention"){
      if(isEditing){
        intentionDisplay.classList.add("hidden");
        intentionText.classList.remove("hidden");
        btnEditIntention.classList.add("hidden");
        btnSaveIntention.classList.remove("hidden");
        btnCancelIntention.classList.remove("hidden");
        intentionText.focus();
      }else{
        intentionDisplay.classList.remove("hidden");
        intentionText.classList.add("hidden");
        btnEditIntention.classList.remove("hidden");
        btnSaveIntention.classList.add("hidden");
        btnCancelIntention.classList.add("hidden");
      }
    }
    if(type === "gratitude"){
      if(isEditing){
        gratitudeDisplay.classList.add("hidden");
        gratitudeText.classList.remove("hidden");
        btnEditGratitude.classList.add("hidden");
        btnSaveGratitude.classList.remove("hidden");
        btnCancelGratitude.classList.remove("hidden");
        gratitudeText.focus();
      }else{
        gratitudeDisplay.classList.remove("hidden");
        gratitudeText.classList.add("hidden");
        btnEditGratitude.classList.remove("hidden");
        btnSaveGratitude.classList.add("hidden");
        btnCancelGratitude.classList.add("hidden");
      }
    }
  }

  // --- Intention / Gratitude render ---
  function renderJournal(){
    const all = ensureDay(loadAll(), activeDateKey);
    const day = all[activeDateKey];

    // Intention
    const it = (day.intentionText || "").trim();
    intentionDisplay.textContent = it ? it : "No intention yet — tap Edit.";
    intentionText.value = day.intentionText || "";

    // Dots
    dotRow.innerHTML = "";
    const score = day.intentionScore || 0;
    for(let i=1;i<=3;i++){
      const b = document.createElement("div");
      b.className = "dotBtn" + (i <= score ? " on" : "");
      b.title = `Set score to ${i}`;
      b.addEventListener("click", () => {
        const latest = ensureDay(loadAll(), activeDateKey);
        latest[activeDateKey].intentionScore = (latest[activeDateKey].intentionScore === i) ? 0 : i;
        saveAll(latest);
        renderJournal();
        renderCalendar();
        renderHistoryList();
      });
      dotRow.appendChild(b);
    }

    // Gratitude
    const gt = (day.gratitudeText || "").trim();
    gratitudeDisplay.textContent = gt ? gt : "No gratitude note yet — tap Edit.";
    gratitudeText.value = day.gratitudeText || "";
  }

  // Intention events
  btnEditIntention.addEventListener("click", ()=> setEditMode("intention", true));
  btnCancelIntention.addEventListener("click", ()=> { setEditMode("intention", false); renderJournal(); });
  btnSaveIntention.addEventListener("click", ()=>{
    const latest = ensureDay(loadAll(), activeDateKey);
    latest[activeDateKey].intentionText = intentionText.value || "";
    saveAll(latest);
    setEditMode("intention", false);
    renderJournal();
    renderCalendar();
    renderHistoryList();
  });

  // Gratitude events
  btnEditGratitude.addEventListener("click", ()=> setEditMode("gratitude", true));
  btnCancelGratitude.addEventListener("click", ()=> { setEditMode("gratitude", false); renderJournal(); });
  btnSaveGratitude.addEventListener("click", ()=>{
    const latest = ensureDay(loadAll(), activeDateKey);
    latest[activeDateKey].gratitudeText = gratitudeText.value || "";
    saveAll(latest);
    setEditMode("gratitude", false);
    renderJournal();
    renderCalendar();
    renderHistoryList();
  });

  // --- Daily grid ---
  function renderToday(){
    const all = ensureDay(loadAll(), activeDateKey);
    const today = all[activeDateKey];

    renderJournal();

    elGrid.innerHTML = "";
    addHeaderRows(elGrid);

    for(const pillar of PILLARS){
      elGrid.appendChild(pillDiv(pillar));
      for(let i=0;i<6;i++){
        const isOn = today[pillar][i] === 1;
        const c = document.createElement("div");
        c.className = "cell" + (isOn ? " on" : "");
        c.addEventListener("click", () => {
          const latest = ensureDay(loadAll(), activeDateKey);
          latest[activeDateKey][pillar][i] = latest[activeDateKey][pillar][i] ? 0 : 1;
          saveAll(latest);
          renderToday();
          renderWeekly();
          renderMonthly();
          renderCalendar();
          renderHistoryList();
        });
        elGrid.appendChild(c);
      }
    }
  }

  // --- Weekly/Monthly ---
  function lastNDaysKeys(anchorKey, n){
    const anchor = parseDateKey(anchorKey);
    const keys = [];
    for(let k=0;k<n;k++){
      const d = new Date(anchor);
      d.setDate(anchor.getDate() - k);
      keys.push(isoLocalDate(d));
    }
    return keys;
  }
  function monthKeysFor(dateKey){
    const d = parseDateKey(dateKey);
    const y = d.getFullYear();
    const m = d.getMonth();
    const daysInMonth = new Date(y, m+1, 0).getDate();
    const keys = [];
    for(let day=1; day<=daysInMonth; day++){
      keys.push(isoLocalDate(new Date(y, m, day)));
    }
    return { keys, daysInMonth, label: monthName(new Date(y, m, 1)) };
  }
  function computeCounts(keys){
    const all = loadAll();
    const counts = {};
    for(const p of PILLARS) counts[p] = Array(6).fill(0);

    for(const key of keys){
      const day = all[key];
      if(!day) continue;
      for(const p of PILLARS){
        const arr = day[p] || Array(6).fill(0);
        for(let i=0;i<6;i++) counts[p][i] += (arr[i] ? 1 : 0);
      }
    }
    return counts;
  }
  function renderHeatmap(targetEl, counts, denom){
    targetEl.innerHTML = "";
    addHeaderRows(targetEl);

    for(const p of PILLARS){
      targetEl.appendChild(pillDiv(p));
      for(let i=0;i<6;i++){
        const val = counts[p][i];
        const pct = denom ? (val/denom) : 0;
        const cell = document.createElement("div");
        cell.className = "hmcell";
        cell.style.background = `rgba(255, 95, 162, ${0.04 + pct*0.34})`;
        cell.style.borderColor = `rgba(255,255,255, ${0.08 + pct*0.25})`;
        cell.innerHTML = `<strong>${val}</strong><span class="small">/${denom}</span>`;
        targetEl.appendChild(cell);
      }
    }
  }
  function renderWeekly(){
    const keys = lastNDaysKeys(activeDateKey, 7);
    const counts = computeCounts(keys);
    renderHeatmap(elWeeklyGrid, counts, 7);
    elWeeklyLabel.textContent = `Week ending ${activeDateKey}`;
  }
  function renderMonthly(){
    const { keys, daysInMonth, label } = monthKeysFor(activeDateKey);
    const counts = computeCounts(keys);
    renderHeatmap(elMonthlyGrid, counts, daysInMonth);
    elMonthlyLabel.textContent = `${label}`;
  }

  // --- History ---
  function renderCalendar(){
    const all = loadAll();
    const cursor = new Date(calCursor.getFullYear(), calCursor.getMonth(), 1);
    elCalMonthLabel.textContent = monthName(cursor);

    const savedKeys = Object.keys(all).filter(k => dayHasAnySelection(all[k]));
    elDataBadge.textContent = `${savedKeys.length} days saved`;
    elDataBadge.className = "badge" + (savedKeys.length ? " on" : "");

    elCalendar.innerHTML = "";
    const dows = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    for(const d of dows){
      const el = document.createElement("div");
      el.className = "dow";
      el.textContent = d;
      elCalendar.appendChild(el);
    }

    const firstDow = cursor.getDay();
    const daysInMonth = new Date(cursor.getFullYear(), cursor.getMonth()+1, 0).getDate();

    for(let i=0;i<firstDow;i++){
      const blank = document.createElement("div");
      blank.className = "day muted";
      elCalendar.appendChild(blank);
    }

    for(let day=1; day<=daysInMonth; day++){
      const d = new Date(cursor.getFullYear(), cursor.getMonth(), day);
      const key = isoLocalDate(d);
      const hasData = dayHasAnySelection(all[key]);
      const isSelected = (key === activeDateKey);

      const el = document.createElement("div");
      el.className = "day" + (hasData ? " hasData" : "") + (isSelected ? " selected" : "");
      el.innerHTML = `<div>${day}</div><div class="small">${hasData ? "•" : ""}</div>`;
      el.addEventListener("click", ()=> setActiveDate(key));
      elCalendar.appendChild(el);
    }
  }

  function renderHistoryList(){
    const all = loadAll();
    const keys = Object.keys(all)
      .filter(k => dayHasAnySelection(all[k]))
      .sort((a,b)=> b.localeCompare(a));

    elHistoryList.innerHTML = `<div class="subtle" style="margin-top:10px;">Saved days (newest first)</div>`;

    if(keys.length === 0){
      const empty = document.createElement("div");
      empty.className = "subtle";
      empty.style.marginTop = "8px";
      empty.textContent = "No saved days yet — start tapping boxes and they’ll show up here.";
      elHistoryList.appendChild(empty);
      return;
    }

    for(const k of keys.slice(0, 20)){
      const item = document.createElement("div");
      item.className = "historyItem";

      const count = countSelectionsInDay(all[k]);
      const score = all[k].intentionScore || 0;
      const it = (all[k].intentionText || "").trim();
      const gt = (all[k].gratitudeText || "").trim();

      const right = [];
      if(score) right.push(`${score}/3`);
      right.push(`${count} taps`);

      const leftLines = [];
      leftLines.push(`<strong>${k}</strong>`);
      leftLines.push(`<div class="small">${it ? ("Intention: " + (it.length > 36 ? it.slice(0,36) + "…" : it)) : "No intention"}</div>`);
      leftLines.push(`<div class="small">${gt ? ("Gratitude: " + (gt.length > 36 ? gt.slice(0,36) + "…" : gt)) : "No gratitude"}</div>`);

      item.innerHTML = `
        <div>${leftLines.join("")}</div>
        <div class="small">${right.join(" • ")}</div>
      `;
      item.addEventListener("click", ()=> setActiveDate(k));
      elHistoryList.appendChild(item);
    }
  }

  // Views
  function setView(name){
    document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
    document.getElementById(name).classList.add("active");
    [btnTodayView, btnWeeklyView, btnMonthlyView].forEach(b => b.classList.remove("primary"));
    if(name === "viewToday") btnTodayView.classList.add("primary");
    if(name === "viewWeekly") btnWeeklyView.classList.add("primary");
    if(name === "viewMonthly") btnMonthlyView.classList.add("primary");
  }

  btnTodayView.addEventListener("click", ()=> setView("viewToday"));
  btnWeeklyView.addEventListener("click", ()=> setView("viewWeekly"));
  btnMonthlyView.addEventListener("click", ()=> setView("viewMonthly"));

  btnClear.addEventListener("click", ()=>{
    const all = loadAll();
    if(all[activeDateKey]) delete all[activeDateKey];
    saveAll(all);
    setEditMode("intention", false);
    setEditMode("gratitude", false);
    renderToday(); renderWeekly(); renderMonthly(); renderCalendar(); renderHistoryList();
  });

  btnPrevMonth.addEventListener("click", ()=>{
    calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()-1, 1);
    renderCalendar();
  });
  btnNextMonth.addEventListener("click", ()=>{
    calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()+1, 1);
    renderCalendar();
  });
  btnJumpToday.addEventListener("click", ()=>{
    const t = new Date();
    calCursor = new Date(t.getFullYear(), t.getMonth(), 1);
    setActiveDate(isoLocalDate(t));
  });

  // Install flow (Android)
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredInstallPrompt = e;
    btnInstall.classList.remove("hidden");
  });
  btnInstall.addEventListener("click", async () => {
    if(!deferredInstallPrompt) return;
    deferredInstallPrompt.prompt();
    await deferredInstallPrompt.userChoice;
    deferredInstallPrompt = null;
    btnInstall.classList.add("hidden");
  });

  // PWA SW
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try{
        await navigator.serviceWorker.register("./service-worker.js", { scope: "./" });
      }catch(e){}
    });
  }

  // INIT
  migrateIfNeeded();
  elActiveLabel.textContent = `Selected day: ${activeDateKey}`;
  calCursor = new Date();
  setEditMode("intention", false);
  setEditMode("gratitude", false);
  renderToday();
  renderWeekly();
  renderMonthly();
  renderCalendar();
  renderHistoryList();
</script>
</body>
</html>
