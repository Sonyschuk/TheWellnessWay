<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Flow — 6 Pillars</title>

  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.json" />

  <style>
    :root{
      --bg:#0b1220;
      --line:rgba(255,255,255,.08);
      --muted:#93a4c7;
      --text:#e8eefc;
      --cell:#0f1729;
      --pink:#ff5fa2;
      --pinkSoft: rgba(255,95,162,.22);
      --good: rgba(86, 232, 170, .18);
      --warn: rgba(255, 210, 110, .18);
      --bad: rgba(255, 120, 120, .18);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(255,95,162,.12), transparent 60%),
                  radial-gradient(900px 500px at 100% 30%, rgba(43,108,255,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1180px; margin:0 auto; padding:24px}
    .topbar{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;}
    h1{margin:0; font-size:22px; letter-spacing:.2px}
    .date{color:var(--muted); font-size:14px; margin-top:4px}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap}
    button{
      background:transparent; border:1px solid var(--line); color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer;
    }
    button:hover{border-color:rgba(255,255,255,.2)}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      margin-top:14px;
    }
    .sectionTitle{font-weight:750; margin:0 0 8px 0}
    .subtle{color:var(--muted); font-size:13px; line-height:1.35}
    .layout{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap:14px;
    }

    /* Grid with AM/PM header row */
    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 170px repeat(6, 1fr);
      gap:10px;
      align-items:stretch;
    }
    .hdr{
      color:var(--muted);
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:10px 8px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    .hdr.left{justify-content:flex-start;border-bottom:none;padding:0}
    .hdrBand{
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(255,255,255,.02);
    }
    .hdrBand.am{box-shadow: inset 0 0 0 1px rgba(255,95,162,.10)}
    .hdrBand.pm{box-shadow: inset 0 0 0 1px rgba(255,255,255,.06)}
    .hdrBand span{
      display:inline-block;
      padding:10px 0;
      width:100%;
      font-weight:700;
      letter-spacing:.18em;
    }

    .pill{
      display:flex; align-items:center;
      padding:14px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(255,255,255,.02);
      font-weight:650;
    }
    .cell{
      border:1px solid var(--line);
      border-radius:14px;
      background: var(--cell);
      min-height:54px;
      padding:10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      user-select:none;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .cell:hover{border-color:rgba(255,255,255,.18)}
    .cell:active{transform:scale(.99)}
    .cell.on{
      background: var(--pinkSoft);
      border-color: rgba(255,95,162,.55);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,95,162,.25);
    }
    .legend{display:flex; gap:14px; align-items:center; color:var(--muted); font-size:13px; margin-top:10px; flex-wrap:wrap}
    .dot{width:10px; height:10px; border-radius:999px; display:inline-block; border:1px solid var(--line); background:var(--cell)}
    .dot.on{background:rgba(255,95,162,.35); border-color:rgba(255,95,162,.55)}
    .small{font-size:12px}

    /* Weekly */
    .weeklyGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: 170px repeat(6, 1fr);
      gap:10px;
    }
    .wkcell{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      min-height:54px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      background: rgba(255,255,255,.02);
    }
    .wkcell strong{color:var(--text)}
    .insights{margin-top:10px;display:grid;grid-template-columns:1fr;gap:10px}
    .insightBox{border:1px solid var(--line);border-radius:14px;padding:12px;background: rgba(255,255,255,.02)}
    ul.clean{margin:8px 0 0 18px; padding:0}
    ul.clean li{margin:6px 0}

    /* Calendar */
    .calTop{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .calTitle{font-weight:750}
    .calBtns{display:flex; gap:8px; flex-wrap:wrap}
    .calendar{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }
    .dow{
      color:var(--muted);
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:8px 6px;
      border-bottom:1px solid var(--line);
    }
    .day{
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(255,255,255,.02);
      min-height:48px;
      padding:8px 8px;
      cursor:pointer;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      color:var(--muted);
    }
    .day:hover{border-color:rgba(255,255,255,.2)}
    .day.muted{opacity:.35; cursor:default}
    .day.selected{
      border-color: rgba(255,95,162,.6);
      box-shadow: inset 0 0 0 1px rgba(255,95,162,.25);
      color:var(--text);
    }
    .day.hasData{background: rgba(255,95,162,.10)}
    .badge{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
    }
    .badge.on{border-color:rgba(255,95,162,.5); color:var(--text); background: rgba(255,95,162,.14)}
    .historyList{margin-top:10px; max-height:260px; overflow:auto}
    .historyItem{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(255,255,255,.02);
      margin-top:8px;
      cursor:pointer;
      color:var(--muted);
    }
    .historyItem:hover{border-color:rgba(255,255,255,.2)}
    .historyItem strong{color:var(--text)}

    /* Import/Export panel */
    .ioGrid{display:grid; grid-template-columns: 1fr; gap:10px; margin-top:10px}
    textarea{
      width:100%;
      min-height:140px;
      background: rgba(15, 23, 41, .75);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      color: var(--text);
      padding:12px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
      line-height:1.35;
    }
    .rowBtns{display:flex; gap:10px; flex-wrap:wrap}
    .hint{color:var(--muted); font-size:12px}
    .pillbtn{border-color:rgba(255,255,255,.14)}
    .pillbtn.good{background: var(--good)}
    .pillbtn.warn{background: var(--warn)}
    .pillbtn.bad{background: var(--bad)}

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(15, 23, 41, .92);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 12px 36px rgba(0,0,0,.35);
      display:none;
      gap:10px;
      align-items:center;
      max-width:min(520px, calc(100vw - 28px));
      z-index: 9999;
    }
    .toast .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,95,162,.55);
      border:1px solid rgba(255,95,162,.65);
    }
    .toast .msg{color:var(--text); font-size:13px}
    .toast .sub{color:var(--muted); font-size:12px; margin-top:2px}
    .toast .stack{display:flex; flex-direction:column}

    details summary{cursor:pointer; font-weight:650}

    @media(max-width:980px){
      .layout{grid-template-columns: 1fr}
      .grid,.weeklyGrid{grid-template-columns: 130px repeat(6, 1fr)}
      .pill{padding:12px 10px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Daily Flow — 6 Pillars</h1>
        <div class="date" id="activeLabel"></div>
      </div>
      <div class="btnrow">
        <button id="btnToday">Today</button>
        <button id="btnWeekly">Weekly View</button>
        <button id="btnClearActive">Clear This Day</button>
        <button id="btnOpenIO">Import / Export</button>
      </div>
    </div>

    <div class="layout">
      <!-- Left: Daily / Weekly -->
      <div>
        <div class="card" id="viewToday">
          <p class="sectionTitle">Daily Map</p>
          <p class="subtle">Tap the boxes where you feel strongest in each pillar. Multiple selections are allowed.</p>
          <div class="grid" id="grid"></div>
          <div class="legend">
            <span><span class="dot"></span> off</span>
            <span><span class="dot on"></span> selected</span>
            <span class="small">Slots: Early AM, Mid AM, Late AM, Early PM, Mid PM, Late PM</span>
          </div>
        </div>

        <div class="card" id="viewWeekly" style="display:none;">
          <p class="sectionTitle">Weekly Heatmap (last 7 days)</p>
          <p class="subtle">Intensity is based on how many days that slot was selected (0–7) in the last week.</p>
          <div class="weeklyGrid" id="weeklyGrid"></div>
          <div class="insights" id="insights"></div>
        </div>

        <!-- Import / Export panel (collapsible) -->
        <div class="card" id="ioCard" style="display:none;">
          <p class="sectionTitle">Import / Export</p>
          <p class="subtle">Best workflow: <strong>Copy</strong> on one device → paste here → <strong>Import</strong> on another.</p>

          <div class="rowBtns">
            <button class="pillbtn good" id="btnCopyAll">Copy All Data</button>
            <button class="pillbtn" id="btnDownloadJson">Download JSON</button>
            <button class="pillbtn" id="btnUploadFile">Import from File</button>
            <button class="pillbtn warn" id="btnImportPaste">Import from Paste</button>
            <button class="pillbtn bad" id="btnCloseIO">Close</button>
          </div>

          <div class="ioGrid">
            <textarea id="ioText" placeholder="Paste your data here (JSON)..."></textarea>
            <div class="hint">
              Tip: If you ever accidentally saved a .txt, it’s fine — open it, copy all contents, paste here, then click <strong>Import from Paste</strong>.
            </div>
          </div>
        </div>
      </div>

      <!-- Right: History -->
      <div class="card">
        <div class="calTop">
          <div>
            <div class="calTitle">History</div>
            <div class="subtle">Click a day to view/edit. Days with data are highlighted.</div>
          </div>
          <div class="calBtns">
            <button id="btnPrevMonth">◀</button>
            <button id="btnNextMonth">▶</button>
            <button id="btnJumpToday">Jump to Today</button>
          </div>
        </div>

        <div class="calTop" style="margin-top:10px;">
          <div class="calTitle" id="calMonthLabel"></div>
          <div class="badge" id="dataBadge">0 days saved</div>
        </div>

        <div class="calendar" id="calendar"></div>
        <div class="historyList" id="historyList"></div>
      </div>
    </div>

    <!-- Pillar Descriptions moved to bottom -->
    <div class="card">
      <details>
        <summary>Pillar Descriptions</summary>
        <div class="desc">
          <ol>
            <li><strong>Energy</strong> — Find patterns to help you map your day according to your natural energy levels. You are not yourself when tired and hungry.</li>
            <li><strong>Mind</strong> — Prioritize mental health and put positive psychology into action with daily intentions, brain dumps, and gratitude affirmations.</li>
            <li><strong>Movement</strong> — Celebrate movement, from seated stretches to gentle walks and high-impact activities.</li>
            <li><strong>Nourishment</strong> — Let go of rigid goals to make space for favorite recipes and food that makes your body and mind feel good.</li>
            <li><strong>Connection</strong> — Foster kind, inspiring moments with the people and things that lift you up — experiences, culture, or in-person interactions.</li>
            <li><strong>Rest</strong> — The antidote to “to-do”. Build screen-free downtime into your day and explore stillness, micro naps, and meditations.</li>
          </ol>
        </div>
      </details>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite">
    <span class="dot"></span>
    <div class="stack">
      <div class="msg" id="toastMsg">Saved</div>
      <div class="sub" id="toastSub"></div>
    </div>
  </div>

<script>
  const PILLARS = ["Energy","Mind","Movement","Nourishment","Connection","Rest"];
  const SLOTS = ["Early AM","Mid AM","Late AM","Early PM","Mid PM","Late PM"];
  const STORE_KEY = "dailyFlow.pillars.v4";

  const elActiveLabel = document.getElementById("activeLabel");
  const elGrid = document.getElementById("grid");
  const elWeeklyGrid = document.getElementById("weeklyGrid");
  const elInsights = document.getElementById("insights");

  const viewToday = document.getElementById("viewToday");
  const viewWeekly = document.getElementById("viewWeekly");

  const btnToday = document.getElementById("btnToday");
  const btnWeekly = document.getElementById("btnWeekly");
  const btnClearActive = document.getElementById("btnClearActive");
  const btnOpenIO = document.getElementById("btnOpenIO");

  const ioCard = document.getElementById("ioCard");
  const btnCloseIO = document.getElementById("btnCloseIO");
  const btnCopyAll = document.getElementById("btnCopyAll");
  const btnDownloadJson = document.getElementById("btnDownloadJson");
  const btnUploadFile = document.getElementById("btnUploadFile");
  const btnImportPaste = document.getElementById("btnImportPaste");
  const ioText = document.getElementById("ioText");

  const btnPrevMonth = document.getElementById("btnPrevMonth");
  const btnNextMonth = document.getElementById("btnNextMonth");
  const btnJumpToday = document.getElementById("btnJumpToday");

  const elCalMonthLabel = document.getElementById("calMonthLabel");
  const elCalendar = document.getElementById("calendar");
  const elHistoryList = document.getElementById("historyList");
  const elDataBadge = document.getElementById("dataBadge");

  // Toast
  const elToast = document.getElementById("toast");
  const elToastMsg = document.getElementById("toastMsg");
  const elToastSub = document.getElementById("toastSub");
  let toastTimer = null;

  let activeDateKey = isoLocalDate(new Date());
  let calCursor = new Date();

  function pad(n){ return String(n).padStart(2,"0"); }
  function isoLocalDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function parseDateKey(key){ const [y,m,dd]=key.split("-").map(Number); return new Date(y, m-1, dd); }
  function monthName(d){ return d.toLocaleString(undefined, {month:"long", year:"numeric"}); }

  function toast(msg, sub=""){
    if(toastTimer) clearTimeout(toastTimer);
    elToastMsg.textContent = msg;
    elToastSub.textContent = sub;
    elToast.style.display = "flex";
    toastTimer = setTimeout(()=>{ elToast.style.display = "none"; }, 1300);
  }

  function loadAll(){
    try{ return JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); }
    catch(e){ return {}; }
  }
  function saveAll(data){ localStorage.setItem(STORE_KEY, JSON.stringify(data)); }

  function ensureDay(data, dateKey){
    if(!data[dateKey]) data[dateKey] = {};
    for(const p of PILLARS){
      if(!data[dateKey][p]) data[dateKey][p] = Array(6).fill(0);
    }
    return data;
  }

  function dayHasAnySelection(dayObj){
    if(!dayObj) return false;
    for(const p of PILLARS){
      const arr = dayObj[p] || [];
      if(arr.some(x => x === 1)) return true;
    }
    return false;
  }
  function countSelectionsInDay(dayObj){
    if(!dayObj) return 0;
    let c=0;
    for(const p of PILLARS){
      const arr = dayObj[p] || [];
      for(const v of arr) c += (v ? 1 : 0);
    }
    return c;
  }

  function setActiveDate(dateKey){
    activeDateKey = dateKey;
    elActiveLabel.textContent = `Selected day: ${activeDateKey}`;
    renderToday();
    renderCalendar();
    renderHistoryList();
    if(viewWeekly.style.display !== "none") renderWeekly();
  }

  function renderToday(){
    const all = ensureDay(loadAll(), activeDateKey);
    const today = all[activeDateKey];

    elGrid.innerHTML = "";

    // Row 1: AM/PM spanning headers
    elGrid.appendChild(cellDiv("", "hdr left"));
    const am = document.createElement("div");
    am.className = "hdr hdrBand am";
    am.style.gridColumn = "2 / span 3";
    am.innerHTML = `<span>AM</span>`;
    elGrid.appendChild(am);

    const pm = document.createElement("div");
    pm.className = "hdr hdrBand pm";
    pm.style.gridColumn = "5 / span 3";
    pm.innerHTML = `<span>PM</span>`;
    elGrid.appendChild(pm);

    // Row 2: slot headers
    elGrid.appendChild(cellDiv("", "hdr"));
    for(const s of SLOTS) elGrid.appendChild(cellDiv(s, "hdr"));

    // Rows
    for(const pillar of PILLARS){
      elGrid.appendChild(pillDiv(pillar));
      for(let i=0;i<6;i++){
        const isOn = today[pillar][i] === 1;
        const c = document.createElement("div");
        c.className = "cell" + (isOn ? " on" : "");
        c.title = `${pillar} — ${SLOTS[i]} (${activeDateKey})`;
        c.addEventListener("click", () => {
          const latest = ensureDay(loadAll(), activeDateKey);
          latest[activeDateKey][pillar][i] = latest[activeDateKey][pillar][i] ? 0 : 1;
          saveAll(latest);

          renderToday();
          renderCalendar();
          renderHistoryList();
          if(viewWeekly.style.display !== "none") renderWeekly();

          toast("Saved", `${pillar} • ${SLOTS[i]} • ${activeDateKey}`);
        });
        elGrid.appendChild(c);
      }
    }
  }

  function getLastNDaysKeys(anchorKey, n=7){
    const anchor = parseDateKey(anchorKey);
    const keys = [];
    for(let k=0;k<n;k++){
      const d = new Date(anchor);
      d.setDate(anchor.getDate() - k);
      keys.push(isoLocalDate(d));
    }
    return keys;
  }

  function renderWeekly(){
    const all = loadAll();
    const keys = getLastNDaysKeys(activeDateKey, 7);

    const counts = {};
    for(const p of PILLARS) counts[p] = Array(6).fill(0);

    for(const key of keys){
      if(!all[key]) continue;
      for(const p of PILLARS){
        const arr = (all[key] && all[key][p]) ? all[key][p] : Array(6).fill(0);
        for(let i=0;i<6;i++) counts[p][i] += (arr[i] ? 1 : 0);
      }
    }

    elWeeklyGrid.innerHTML = "";
    elWeeklyGrid.appendChild(cellDiv("", "hdr"));
    for(const s of SLOTS) elWeeklyGrid.appendChild(cellDiv(s, "hdr"));

    for(const p of PILLARS){
      elWeeklyGrid.appendChild(pillDiv(p));
      for(let i=0;i<6;i++){
        const val = counts[p][i]; // 0..7
        const pct = val / 7;
        const c = document.createElement("div");
        c.className = "wkcell";
        c.style.background = `rgba(255, 95, 162, ${0.04 + pct * 0.34})`;
        c.style.borderColor = `rgba(255, 255, 255, ${0.08 + pct * 0.25})`;
        c.innerHTML = `<strong>${val}</strong><span class="small">/7</span>`;
        elWeeklyGrid.appendChild(c);
      }
    }

    renderInsights(counts);
  }

  function renderInsights(counts){
    const perPillar = [];
    for(const p of PILLARS){
      let bestI = 0;
      for(let i=1;i<6;i++) if(counts[p][i] > counts[p][bestI]) bestI = i;
      perPillar.push({pillar:p, slot:bestI, val:counts[p][bestI]});
    }

    const slotTotals = Array(6).fill(0);
    for(const p of PILLARS){
      for(let i=0;i<6;i++) slotTotals[i] += counts[p][i];
    }
    const topSlots = slotTotals
      .map((v,i)=>({i,v}))
      .sort((a,b)=>b.v-a.v)
      .slice(0,3);

    const pillarTotals = PILLARS.map(p => ({
      pillar:p,
      v: counts[p].reduce((a,b)=>a+b,0)
    })).sort((a,b)=>b.v-a.v);

    elInsights.innerHTML = "";

    const box1 = document.createElement("div");
    box1.className = "insightBox";
    box1.innerHTML = `
      <div class="sectionTitle" style="margin:0;">Insights (ending ${activeDateKey})</div>
      <div class="subtle">Your patterns over the last 7 days.</div>
    `;

    const box2 = document.createElement("div");
    box2.className = "insightBox";
    box2.innerHTML = `
      <div style="font-weight:700;">Top time slots (overall)</div>
      <ul class="clean subtle">
        ${topSlots.map(s => `<li><strong>${SLOTS[s.i]}</strong> — ${s.v} total selections</li>`).join("")}
      </ul>
    `;

    const box3 = document.createElement("div");
    box3.className = "insightBox";
    box3.innerHTML = `
      <div style="font-weight:700;">Peak slot per pillar</div>
      <ul class="clean subtle">
        ${perPillar.map(x => `<li><strong>${x.pillar}</strong> — ${SLOTS[x.slot]} (${x.val}/7)</li>`).join("")}
      </ul>
    `;

    const box4 = document.createElement("div");
    box4.className = "insightBox";
    box4.innerHTML = `
      <div style="font-weight:700;">Most consistent pillar</div>
      <div class="subtle"><strong>${pillarTotals[0].pillar}</strong> — ${pillarTotals[0].v} selections this week</div>
    `;

    elInsights.appendChild(box1);
    elInsights.appendChild(box2);
    elInsights.appendChild(box3);
    elInsights.appendChild(box4);
  }

  function renderCalendar(){
    const all = loadAll();
    const cursor = new Date(calCursor.getFullYear(), calCursor.getMonth(), 1);
    elCalMonthLabel.textContent = monthName(cursor);

    const savedKeys = Object.keys(all).filter(k => dayHasAnySelection(all[k]));
    elDataBadge.textContent = `${savedKeys.length} days saved`;
    elDataBadge.className = "badge" + (savedKeys.length ? " on" : "");

    elCalendar.innerHTML = "";
    const dows = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    for(const d of dows){
      const el = document.createElement("div");
      el.className = "dow";
      el.textContent = d;
      elCalendar.appendChild(el);
    }

    const firstDow = cursor.getDay();
    const daysInMonth = new Date(cursor.getFullYear(), cursor.getMonth()+1, 0).getDate();

    for(let i=0;i<firstDow;i++){
      const blank = document.createElement("div");
      blank.className = "day muted";
      elCalendar.appendChild(blank);
    }

    for(let day=1; day<=daysInMonth; day++){
      const d = new Date(cursor.getFullYear(), cursor.getMonth(), day);
      const key = isoLocalDate(d);
      const hasData = dayHasAnySelection(all[key]);
      const isSelected = (key === activeDateKey);

      const el = document.createElement("div");
      el.className = "day" + (hasData ? " hasData" : "") + (isSelected ? " selected" : "");
      el.innerHTML = `<div>${day}</div><div class="small">${hasData ? "•" : ""}</div>`;
      el.addEventListener("click", ()=> setActiveDate(key));
      elCalendar.appendChild(el);
    }
  }

  function renderHistoryList(){
    const all = loadAll();
    const keys = Object.keys(all)
      .filter(k => dayHasAnySelection(all[k]))
      .sort((a,b)=> b.localeCompare(a));

    elHistoryList.innerHTML = `<div class="subtle" style="margin-top:10px;">Saved days (newest first)</div>`;

    if(keys.length === 0){
      const empty = document.createElement("div");
      empty.className = "subtle";
      empty.style.marginTop = "8px";
      empty.textContent = "No saved days yet — start tapping boxes and they’ll show up here.";
      elHistoryList.appendChild(empty);
      return;
    }

    const show = keys.slice(0, 20);
    for(const k of show){
      const item = document.createElement("div");
      item.className = "historyItem";
      const count = countSelectionsInDay(all[k]);
      item.innerHTML = `<div><strong>${k}</strong><div class="small subtle">${count} selections</div></div><div class="small">Open →</div>`;
      item.addEventListener("click", ()=> setActiveDate(k));
      elHistoryList.appendChild(item);
    }
  }

  function cellDiv(text, cls){
    const d = document.createElement("div");
    d.className = cls;
    d.textContent = text;
    return d;
  }
  function pillDiv(text){
    const d = document.createElement("div");
    d.className = "pill";
    d.textContent = text;
    return d;
  }

  // Import/Export helpers
  function getAllData(){
    return loadAll();
  }
  function downloadJson(data){
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "daily-flow-data.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }
  async function copyToClipboard(text){
    await navigator.clipboard.writeText(text);
  }
  function mergeAndSave(incoming){
    const current = loadAll();
    const merged = {...current, ...incoming}; // incoming wins per day key
    saveAll(merged);
  }

  // Buttons
  btnToday.addEventListener("click", ()=>{
    viewToday.style.display = "";
    viewWeekly.style.display = "none";
    toast("Today view", activeDateKey);
  });

  btnWeekly.addEventListener("click", ()=>{
    viewToday.style.display = "none";
    viewWeekly.style.display = "";
    renderWeekly();
    toast("Weekly view", `Last 7 days ending ${activeDateKey}`);
  });

  btnClearActive.addEventListener("click", ()=>{
    const all = loadAll();
    if(all[activeDateKey]) delete all[activeDateKey];
    saveAll(all);
    renderToday(); renderCalendar(); renderHistoryList();
    if(viewWeekly.style.display !== "none") renderWeekly();
    toast("Cleared", `Removed entries for ${activeDateKey}`);
  });

  btnOpenIO.addEventListener("click", ()=>{
    ioCard.style.display = (ioCard.style.display === "none" ? "" : "none");
    if(ioCard.style.display !== "none"){
      // prefill with current data so copy/paste is easy
      ioText.value = JSON.stringify(getAllData(), null, 2);
      toast("Import/Export", "Copy or paste data here");
      // scroll to card gently
      ioCard.scrollIntoView({behavior:"smooth", block:"start"});
    }
  });

  btnCloseIO.addEventListener("click", ()=>{
    ioCard.style.display = "none";
    toast("Closed", "Import/Export panel");
  });

  btnCopyAll.addEventListener("click", async ()=>{
    try{
      const text = JSON.stringify(getAllData());
      await copyToClipboard(text);
      toast("Copied", "All data copied to clipboard");
    }catch(e){
      toast("Copy failed", "Browser blocked clipboard — use Download JSON instead");
    }
  });

  btnDownloadJson.addEventListener("click", ()=>{
    downloadJson(getAllData());
    toast("Downloaded", "daily-flow-data.json");
  });

  btnUploadFile.addEventListener("click", ()=>{
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".json,.txt,application/json,text/plain";
    input.onchange = async () => {
      const file = input.files[0];
      if(!file) return;
      const text = await file.text();
      ioText.value = text; // show what was loaded
      try{
        const incoming = JSON.parse(text);
        mergeAndSave(incoming);
        renderToday(); renderCalendar(); renderHistoryList();
        if(viewWeekly.style.display !== "none") renderWeekly();
        toast("Imported", "File imported & merged");
      }catch(e){
        toast("Import failed", "File content isn't valid JSON — try copy/paste instead");
      }
    };
    input.click();
  });

  btnImportPaste.addEventListener("click", ()=>{
    const text = (ioText.value || "").trim();
    if(!text){
      toast("Nothing to import", "Paste data first");
      return;
    }
    try{
      const incoming = JSON.parse(text);
      mergeAndSave(incoming);
      renderToday(); renderCalendar(); renderHistoryList();
      if(viewWeekly.style.display !== "none") renderWeekly();
      toast("Imported", "Pasted data merged successfully");
    }catch(e){
      toast("Import failed", "That paste isn't valid JSON");
    }
  });

  btnPrevMonth.addEventListener("click", ()=>{
    calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()-1, 1);
    renderCalendar();
  });
  btnNextMonth.addEventListener("click", ()=>{
    calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()+1, 1);
    renderCalendar();
  });
  btnJumpToday.addEventListener("click", ()=>{
    const t = new Date();
    calCursor = new Date(t.getFullYear(), t.getMonth(), 1);
    setActiveDate(isoLocalDate(t));
    toast("Jumped to today", isoLocalDate(t));
  });

  // PWA registration
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try{ await navigator.serviceWorker.register("./service-worker.js"); }
      catch(e){ /* silent */ }
    });
  }

  // Init
  elActiveLabel.textContent = `Selected day: ${activeDateKey}`;
  calCursor = new Date();
  renderToday();
  renderCalendar();
  renderHistoryList();
</script>
</body>
</html>
